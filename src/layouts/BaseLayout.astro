---
import "../styles/global.css";

interface Props {
  title?: string;
  description?: string;
}

const {
  title = "Sakai LMS | Great For Learning",
  description = "Sakai is a robust open-source learning management system created by higher ed for higher ed."
} = Astro.props;

const withBase = (path: string) =>
  `${import.meta.env.BASE_URL.replace(/\/$/, "")}/${path.replace(/^\/+/, "")}`;
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <title>{title}</title>
    <link rel="icon" type="image/jpeg" sizes="32x32" href={withBase("/icons/sakai-favicon-32.jpg")} />
    <link rel="icon" type="image/jpeg" sizes="192x192" href={withBase("/icons/sakai-favicon-192.jpg")} />
    <link rel="apple-touch-icon" href={withBase("/icons/sakai-favicon-180.jpg")} />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;700;800;900&family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <slot />
    <div id="sakai-google-translate-root" aria-hidden="true"></div>
    <script is:inline>
      (() => {
        const STORAGE_KEY = "sakai-language";
        const READY_EVENT_NAME = "sakai:translator-ready";

        const normalizeLanguage = (value) => (typeof value === "string" && value.toLowerCase().startsWith("es") ? "es" : "en");

        const getStoredLanguage = () => {
          try {
            const storedValue = localStorage.getItem(STORAGE_KEY);
            return storedValue ? normalizeLanguage(storedValue) : null;
          } catch {
            return null;
          }
        };

        const setStoredLanguage = (language) => {
          try {
            localStorage.setItem(STORAGE_KEY, normalizeLanguage(language));
          } catch {
            // Ignore storage failures (private mode, blocked storage).
          }
        };

        const detectBrowserLanguage = () => {
          const primaryLanguage = Array.isArray(navigator.languages) && navigator.languages.length > 0
            ? navigator.languages[0]
            : navigator.language;
          return normalizeLanguage(primaryLanguage);
        };

        const updateSwitcherUi = (language) => {
          document.documentElement.lang = language;
          document.querySelectorAll("[data-lang-switcher]").forEach((switcher) => {
            switcher.querySelectorAll("[data-lang]").forEach((button) => {
              const targetLanguage = button.getAttribute("data-lang");
              const isActive = targetLanguage === language;
              button.classList.toggle("is-active", isActive);
              button.setAttribute("aria-pressed", isActive ? "true" : "false");
            });
          });
        };

        const selectGoogleLanguage = (language) => {
          const translatorSelect = document.querySelector(".goog-te-combo");
          if (!(translatorSelect instanceof HTMLSelectElement)) {
            return false;
          }

          if (translatorSelect.value !== language) {
            translatorSelect.value = language;
            translatorSelect.dispatchEvent(new Event("change"));
          }

          return true;
        };

        const applyLanguage = (language, { persist = false } = {}) => {
          const normalizedLanguage = normalizeLanguage(language);
          updateSwitcherUi(normalizedLanguage);

          if (persist) {
            setStoredLanguage(normalizedLanguage);
          }

          if (!selectGoogleLanguage(normalizedLanguage)) {
            const onTranslatorReady = () => {
              selectGoogleLanguage(normalizedLanguage);
            };
            window.addEventListener(READY_EVENT_NAME, onTranslatorReady, { once: true });
          }
        };

        const bindLanguageSwitchers = () => {
          document.querySelectorAll("[data-lang-switcher]").forEach((switcher) => {
            switcher.addEventListener("click", (event) => {
              const target = event.target;
              if (!(target instanceof HTMLElement)) {
                return;
              }

              const trigger = target.closest("[data-lang]");
              if (!(trigger instanceof HTMLElement)) {
                return;
              }

              const selectedLanguage = trigger.getAttribute("data-lang");
              if (!selectedLanguage) {
                return;
              }

              applyLanguage(selectedLanguage, { persist: true });
            });
          });
        };

        window.sakaiTranslateInit = () => {
          if (!window.google || !window.google.translate) {
            return;
          }

          new window.google.translate.TranslateElement(
            {
              pageLanguage: "en",
              includedLanguages: "en,es",
              autoDisplay: false
            },
            "sakai-google-translate-root"
          );

          window.dispatchEvent(new Event(READY_EVENT_NAME));
        };

        const initializeLanguage = () => {
          bindLanguageSwitchers();

          const initialLanguage = getStoredLanguage() ?? detectBrowserLanguage();
          applyLanguage(initialLanguage);

          if (!document.querySelector("script[data-sakai-translate-loader]")) {
            const script = document.createElement("script");
            script.src = "https://translate.google.com/translate_a/element.js?cb=sakaiTranslateInit";
            script.async = true;
            script.defer = true;
            script.setAttribute("data-sakai-translate-loader", "true");
            document.head.appendChild(script);
          }
        };

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", initializeLanguage, { once: true });
        } else {
          initializeLanguage();
        }
      })();
    </script>
  </body>
</html>
